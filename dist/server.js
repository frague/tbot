(()=>{var e={817:(e,t,s)=>{const{Telegraf:o}=s(642),r=s(786),{URLSearchParams:n}=s(835),{channelId:a,webhookPath:i,botName:c}=s(863),{TOKEN:d,HEROKU_URL:p,NODE_ENV:m}=process.env,u="production"===m;e.exports=class{constructor(){this.bot=new o(d),this.bot.catch(((e,t)=>{console.warn(`Bot error occured for ${t.updateType}:`,e)})),u&&this.bot.setWebHook(`${p}/${i}`),this.registerCommandsHandlers(),this.bot.on("text",(e=>this.processMessage(e))),console.log(`Telegram bot has started in ${u?"production":"development"} mode`),this.bot.launch()}webhookCallback(){return this.bot.webhookCallback(`/${i}`)}registerCommandsHandlers(){this.bot.command("kick",(({message:e})=>this.kickActions(e,!0))),this.bot.command("unban",(({message:e})=>this.kickActions(e,!1))),this.bot.command("test",(e=>{console.log("Command",e)})),this.bot.command("link",(async({message:{from:e},chat:{id:t,type:s},reply:o})=>{if("private"===s){const{uuid:t}=await(await this.linkAccounts(e.id,e.first_name)).json();if(!t)return o("Невозможно получить ссылку для привязки аккаунта");o(`${e.first_name}, для связи аккаунтов telegram и bezumnoe.ru перейдите по ссылке ниже и авторизуйтесь:`,{reply_markup:{inline_keyboard:[[{text:"Перейти в чат",url:`http://bezumnoe.ru/t/${t}`}]]}})}else o("Необходимо обратиться к боту @bezumnoe_bot в приватном чате")}))}processMessage({message:{text:e,from:t,message_id:s},chat:{id:o},reply:r}){console.log(`${t.first_name}: ${e}`),o===a?this.postToChat(t.first_name,e,t.id).then((e=>{console.log("Message acknowledged:",s)})):r("Привет, "+t.first_name+"! Заходи в группу https://t.me/bezumnoe")}processChatUpdate(e){console.log("Chat",JSON.stringify(e));var t=e.text,s=!1;""===e.user_id?t="&#127988; "+(t="<i>"+t.replace(/&[lr]aquo;/g,'"')+"</i>").replace(/<a[^>]*>/g,"").replace(/<\/a>/g,""):e.user_id===e.to_user_id?t="<i>"+e.user_name+" "+t+"</i>":-2===e.user_id?(t="&#8680; "+t,s=!0):-3===e.user_id?(t="&#8678; "+t,s=!0):t="<b>"+e.user_name+"</b>: "+t,s&&(t=t.replace(/<a[^>]*>/g,"<b>").replace(/<\/a>/g,"</b>")),this.bot.telegram.sendMessage(a,t,{parse_mode:"HTML"})}postToChat(e,t,s){const o={user:e,message:t,user_id:s};return this.postJson("telegram",o),this.post("external_messages.service",o)}post(e,t){const s=new n;return Object.entries(t).forEach((([e,t])=>s.append(e,t))),r(`http://bezumnoe.ru/services/${e}.php`,{method:"post",body:s})}postJson(e,t){var s={method:"post",body:JSON.stringify(t),headers:{"Content-Type":"application/json"}};return r(`https://bzmn.xyz/api/${e}`,s)}linkAccounts(e,t){return this.post("telegram_linker.service",{user_id:e,username:t})}async kickActions({reply_to_message:e,from:{id:t},chat:{id:s},reply:o},r){if(!e)return o("Это работает только в ответе на сообщение");if(e.from.username===c)return o("Не балуй!");const{me:n,target:a}=await post("rights.service",{mtid:t,ttid:e.from.id});if(n>=20&&n>=a){var i=e.from.first_name;return r?this.bot.kickChatMember(s,e.from.id).then((e=>{e&&this.bot.sendMessage(s,"<i>"+i+" занесён в черный список</i>",{parse_mode:"HTML"})})):this.bot.unbanChatMember(s,e.from.id).then((e=>{e&&this.bot.sendMessage(s,"<i>"+i+" удалён из черного списка</i>",{parse_mode:"HTML"})}))}return this.bot.sendMessage(s,"Прав маловато...")}}},306:e=>{"use strict";e.exports=JSON.parse('{"name":"bezumnoe-telegram-bot","version":"2.0.1","engines":{"node":"16.x"},"description":"Telegram bot to integrate bezumnoe.ru chatrooms with telegram","main":"index.js","scripts":{"start_old":"export $(cat .env | xargs) && ./node_modules/.bin/babel-node index.js","start":"node ./dist/server.js","build":"webpack --mode production","set_env":"export $(cat .env | xargs)","dev":"npm run set_env && wget --spider https://api.telegram.org/bot$TOKEN/setWebhook?url= --delete-after && node index.js"},"author":"Nick Bogdanov","license":"ISC","dependencies":{"express":"^4.17.1","node-fetch":"^2.6.5","telegraf":"^4.4.2"},"devDependencies":{"clean-webpack-plugin":"^3.0.0","webpack":"^5.9.0","webpack-cli":"^4.2.0","webpack-node-externals":"^2.5.2"}}')},863:e=>{"use strict";e.exports=JSON.parse('{"channelId":-1001100829569,"webhookPath":"/thook","botName":"bezumnoe_bot"}')},127:e=>{"use strict";e.exports=require("express")},786:e=>{"use strict";e.exports=require("node-fetch")},642:e=>{"use strict";e.exports=require("telegraf")},835:e=>{"use strict";e.exports=require("url")}},t={};function s(o){if(t[o])return t[o].exports;var r=t[o]={exports:{}};return e[o](r,r.exports,s),r.exports}(()=>{const e=s(127),t=s(817),{version:o}=s(306),r=e();r.use(e.json());const n=new t;r.use(n.webhookCallback("/t")),r.get("/",((e,t)=>t.json({version:o}))),r.post("/push",(({body:e},t)=>{n.processChatUpdate(e),t.status(200).end()}));const a=r.listen(process.env.PORT||8081,"0.0.0.0",(()=>{const{address:e,port:t}=a.address();console.log(`Web server started at https://${e}:${t}`)}))})()})();