(()=>{var e={817:(e,t,s)=>{const{Telegraf:r}=s(642),o=(s(210),s(786)),{URLSearchParams:n}=s(835),{channelId:a,webhookPath:i,botName:c}=s(863),{TOKEN:d,HEROKU_URL:p,NODE_ENV:m}=process.env,l="production"===m;e.exports=class{constructor(){this.bot=new r(d),this.bot.catch(((e,t)=>{console.warn(`Bot error occured for ${t.updateType}:`,e)})),l&&(this.bot.webhookReply=!0,this.bot.telegram.setWebHook(`${p}/${i}`)),this.registerCommandsHandlers(),this.bot.on("text",(e=>this.processMessage(e))),console.log(`Telegram bot has started in ${l?"production":"development"} mode`),this.bot.launch()}webhookCallback(){return this.bot.webhookCallback(`/${i}`)}registerCommandsHandlers(){this.bot.command("kick",(({message:e})=>this.kickActions(e,!0))),this.bot.command("unban",(({message:e})=>this.kickActions(e,!1))),this.bot.command("test",(e=>{console.log("Command",e)})),this.bot.command("link",(async({message:{from:e},chat:{id:t,type:s},reply:r})=>{if("private"===s){const{uuid:t}=await(await this.linkAccounts(e.id,e.first_name)).json();if(!t)return r("Невозможно получить ссылку для привязки аккаунта");r(`${e.first_name}, для связи аккаунтов telegram и bezumnoe.ru перейдите по ссылке ниже и авторизуйтесь:`,{reply_markup:{inline_keyboard:[[{text:"Перейти в чат",url:`http://bezumnoe.ru/t/${t}`}]]}})}else r("Необходимо обратиться к боту @bezumnoe_bot в приватном чате")}))}processMessage({message:{text:e,from:t,message_id:s},chat:{id:r},reply:o}){console.log(`${t.first_name}: ${e}`),r===a?this.postToChat(t.first_name,e,t.id).then((e=>{console.log("Message acknowledged:",s)})):o("Привет, "+t.first_name+"! Заходи в группу https://t.me/bezumnoe")}processChatUpdate(e){console.log("Chat",JSON.stringify(e));var t=e.text,s=!1;""===e.user_id?t="&#127988; "+(t="<i>"+t.replace(/&[lr]aquo;/g,'"')+"</i>").replace(/<a[^>]*>/g,"").replace(/<\/a>/g,""):e.user_id===e.to_user_id?t="<i>"+e.user_name+" "+t+"</i>":-2===e.user_id?(t="&#8680; "+t,s=!0):-3===e.user_id?(t="&#8678; "+t,s=!0):t="<b>"+e.user_name+"</b>: "+t,s&&(t=t.replace(/<a[^>]*>/g,"<b>").replace(/<\/a>/g,"</b>")),this.bot.telegram.sendMessage(a,t,{parse_mode:"HTML"})}postToChat(e,t,s){const r={user:e,message:t,user_id:s};return this.postJson("telegram",r),this.post("external_messages.service",r)}post(e,t){const s=new n;return Object.entries(t).forEach((([e,t])=>s.append(e,t))),o(`http://bezumnoe.ru/services/${e}.php`,{method:"post",body:s})}postJson(e,t){var s={method:"post",body:JSON.stringify(t),headers:{"Content-Type":"application/json"}};return o(`https://bzmn.xyz/api/${e}`,s)}linkAccounts(e,t){return this.post("telegram_linker.service",{user_id:e,username:t})}async kickActions({reply_to_message:e,from:{id:t},chat:{id:s},reply:r},o){if(!e)return r("Это работает только в ответе на сообщение");if(e.from.username===c)return r("Не балуй!");const{me:n,target:a}=await post("rights.service",{mtid:t,ttid:e.from.id});if(n>=20&&n>=a){var i=e.from.first_name;return o?this.bot.kickChatMember(s,e.from.id).then((e=>{e&&this.bot.sendMessage(s,"<i>"+i+" занесён в черный список</i>",{parse_mode:"HTML"})})):this.bot.unbanChatMember(s,e.from.id).then((e=>{e&&this.bot.sendMessage(s,"<i>"+i+" удалён из черного списка</i>",{parse_mode:"HTML"})}))}return this.bot.sendMessage(s,"Прав маловато...")}}},306:e=>{"use strict";e.exports=JSON.parse('{"name":"bezumnoe-telegram-bot","version":"2.0.0","engines":{"node":"14.x"},"description":"Telegram bot to integrate bezumnoe.ru chatrooms with telegram","main":"index.js","scripts":{"start_old":"export $(cat .env | xargs) && ./node_modules/.bin/babel-node index.js","start":"node ./dist/server.js","build":"webpack --mode production","set_env":"export $(cat .env | xargs)","dev":"npm run set_env && wget --spider https://api.telegram.org/bot$TOKEN/setWebhook?url= --delete-after && node index.js"},"author":"Nick Bogdanov","license":"ISC","dependencies":{"express":"^4.17.1","node-fetch":"^2.6.1","telegraf":"^3.38.0"},"devDependencies":{"clean-webpack-plugin":"^3.0.0","webpack":"^5.9.0","webpack-cli":"^4.2.0","webpack-node-externals":"^2.5.2"}}')},863:e=>{"use strict";e.exports=JSON.parse('{"channelId":-1001100829569,"webhookPath":"/thook","botName":"bezumnoe_bot"}')},127:e=>{"use strict";e.exports=require("express")},786:e=>{"use strict";e.exports=require("node-fetch")},642:e=>{"use strict";e.exports=require("telegraf")},210:e=>{"use strict";e.exports=require("telegraf/telegram")},835:e=>{"use strict";e.exports=require("url")}},t={};function s(r){if(t[r])return t[r].exports;var o=t[r]={exports:{}};return e[r](o,o.exports,s),o.exports}(()=>{const e=s(127),t=s(817),{version:r}=s(306),o=e();o.use(e.json());const n=new t;o.use(n.webhookCallback("/t")),o.get("/",((e,t)=>t.json({version:r}))),o.post("/push",(({body:e},t)=>{n.processChatUpdate(e),t.status(200).end()}));const a=o.listen(process.env.PORT||8081,"0.0.0.0",(()=>{const{address:e,port:t}=a.address();console.log(`Web server started at https://${e}:${t}`)}))})()})();